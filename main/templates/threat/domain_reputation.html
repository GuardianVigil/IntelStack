{% extends 'components/layouts/default.html' %}
{% load static %}

{% block content %}
<div x-data="domainAnalysis">
    <ul class="flex space-x-2 rtl:space-x-reverse">
        <li>
            <a href="/" class="text-primary hover:underline">Dashboard</a>
        </li>
        <li class="before:content-['/'] ltr:before:mr-1 rtl:before:ml-1">
            <span>Domain Reputation</span>
        </li>
    </ul>

    <div class="pt-5">
        <div class="panel">
            <div class="flex items-center justify-between mb-5">
                <h5 class="font-semibold text-lg dark:text-white-light">Domain Reputation Analysis</h5>
            </div>

            <div class="mb-5">
                <form @submit.prevent="analyzeDomain" class="space-y-5">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="domain">Domain Name</label>
                            <input id="domain" type="text" placeholder="Enter domain name" class="form-input" x-model="domain" />
                        </div>
                        <div class="sm:pt-7">
                            <button type="submit" class="btn btn-primary">Analyze</button>
                        </div>
                    </div>
                </form>
            </div>

            <div x-show="loading" class="flex justify-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
            </div>

            <div x-show="!loading && results" class="space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="panel flex flex-col items-center justify-center">
                        <h6 class="text-xl font-bold mb-2">Threat Score</h6>
                        <p class="text-3xl font-semibold" x-text="results.quickStats.threatScore"></p>
                    </div>
                    <div class="panel flex flex-col items-center justify-center">
                        <h6 class="text-xl font-bold mb-2">Risk Score</h6>
                        <p class="text-3xl font-semibold" x-text="results.quickStats.riskScore"></p>
                    </div>
                    <div class="panel">
                        <h6 class="text-lg font-bold mb-2">WHOIS Lookup</h6>
                        <div class="table-responsive">
                            <table class="table-striped">
                                <tbody>
                                    <tr>
                                        <td class="font-semibold">Registrar:</td>
                                        <td x-text="results.whois.registrar || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Registration Date:</td>
                                        <td x-text="results.whois.registrationDate || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Expiration Date:</td>
                                        <td x-text="results.whois.expirationDate || 'N/A'"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Contact Email:</td>
                                        <td x-text="results.whois.contactEmail || 'N/A'"></td>
                                    </tr>
                                    <template x-if="results.whois.additionalData">
                                        <template x-for="(value, key) in Object.entries(results.whois.additionalData)" :key="key">
                                            <tr>
                                                <td class="font-semibold" x-text="key + ':'"></td>
                                                <td x-text="value || 'N/A'"></td>
                                            </tr>
                                        </template>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h6 class="text-lg font-bold mb-5">Platform Responses</h6>

                    <div x-data="{ activeTab: 'virustotal' }">
                        <ul class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                            <template x-for="platform in results.platforms" :key="platform.name">
                                <li class="-mb-px mr-2 last:mr-0">
                                    <a href="javascript:;"
                                       class="bg-white inline-block py-2 px-4 text-sm font-semibold text-center border-l border-t border-r rounded-t-lg dark:bg-gray-800 dark:text-white-light"
                                       :class="{'active': activeTab === platform.name.toLowerCase().replace(' ', '') }"
                                       @click="activeTab = platform.name.toLowerCase().replace(' ', '')"
                                       x-text="platform.name"
                                    ></a>
                                </li>
                            </template>
                        </ul>

                        <div class="space-y-5">
                            <template x-for="platform in results.platforms" :key="platform.name">
                                <div x-show="activeTab === platform.name.toLowerCase().replace(' ', '')">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <div class="panel flex flex-col items-center justify-center">
                                            <h6 class="text-md font-bold mb-1">Status</h6>
                                            <span class="badge" :class="{
                                                'badge-outline-success': platform.status === 'Safe',
                                                'badge-outline-warning': platform.status === 'Suspicious',
                                                'badge-outline-danger': platform.status === 'Malicious',
                                                'badge-outline-info': platform.status === 'Unknown'
                                            }" x-text="platform.status"></span>
                                        </div>
                                        <div class="panel flex flex-col items-center justify-center">
                                            <h6 class="text-md font-bold mb-1">Threat Score</h6>
                                            <p class="font-semibold" x-text="platform.threatScore || 'N/A'"></p>
                                        </div>
                                        <div class="panel flex flex-col items-center justify-center">
                                            <h6 class="text-md font-bold mb-1">Risk Assessment</h6>
                                            <p class="font-semibold" x-text="platform.riskAssessment || 'N/A'"></p>
                                        </div>
                                        <div class="panel flex flex-col items-center justify-center md:col-span-3">
                                            <h6 class="text-md font-bold mb-1">Last Analysis Date</h6>
                                            <p class="font-semibold" x-text="platform.lastAnalysisDate || 'N/A'"></p>
                                        </div>
                                    </div>

                                    <div>
                                        <h6 class="text-lg font-bold mb-2">Full JSON Response</h6>
                                        <div class="table-responsive">
                                            <table class="table-striped">
                                                <thead>
                                                    <tr>
                                                        <th>Key</th>
                                                        <th>Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td colspan="2">
                                                            <pre class="text-sm whitespace-pre-wrap" x-text="JSON.stringify(platform.fullResponse, null, 2)"></pre>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="isModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" x-cloak>
        <div class="panel w-3/4 max-w-2xl p-6 rounded-lg overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h5 class="text-lg font-semibold" x-text="selectedPlatform ? selectedPlatform.name + ' - Full Response' : 'Full Response'"></h5>
                <button @click="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <iconify-icon icon="heroicons-outline:x-mark"></iconify-icon>
                </button>
            </div>
            <pre class="text-sm whitespace-pre-wrap" x-text="fullResponseData"></pre>
        </div>
    </div>
</div>

<script>
    document.addEventListener("alpine:init", () => {
        Alpine.data("domainAnalysis", () => ({
            domain: "",
            loading: false,
            results: null,
            isModalOpen: false, // Keeping modal structure for potential future use, though not used for full response now
            selectedPlatform: null,
            fullResponseData: '',

            async analyzeDomain() {
                console.log("analyzeDomain function called!"); // Debugging log

                this.loading = true;
                this.results = null; // Clear previous results

                // Simulate API response with provided data
                const sampleData = `
--- AlienVault OTX Results ---
{
    "general": {
        "sections": [
            "general",
            "url_list",
            "http_scans",
            "screenshot"
        ],
        "indicator": "http://1312stealer.ru",
        "type": "url",
        "type_title": "URL",
        "validation": [],
        "base_indicator": {},
        "pulse_info": {
            "count": 0,
            "pulses": [],
            "references": [],
            "related": {
                "alienvault": {
                    "adversary": [],
                    "malware_families": [],
                    "industries": [],
                    "unique_indicators": 0
                },
                "other": {
                    "adversary": [],
                    "malware_families": [],
                    "industries": [],
                    "unique_indicators": 0
                }
            }
        },
        "false_positive": [],
        "alexa": "http://www.alexa.com/siteinfo/1312stealer.ru",
        "whois": "http://whois.domaintools.com/1312stealer.ru",
        "domain": "1312stealer.ru",
        "hostname": "Unavailable"
    },
    "url_list": {
        "url_list": [
            {
                "url": "http://1312stealer.ru",
                "result": {
                    "urlworker": {
                        "url": "http://1312stealer.ru",
                        "ip": "104.21.9.114",
                        "http_code": 200,
                        "http_response": {
                            "DATE": "Wed, 31 Jul 2024 11:21:09 GMT",
                            "CONTENT-TYPE": "text/html; charset=UTF-8",
                            "TRANSFER-ENCODING": "chunked",
                            "CONNECTION": "keep-alive",
                            "X-FRAME-OPTIONS": "SAMEORIGIN",
                            "REPORT-TO": "{\\"endpoints\\":[{\\"url\\":\\"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=6rXM2chx%2BE9hoCGZzYXJP1dAcvi9RjmP8b4h5tbnn9jzzRknQhHxcX4CQDn9QgCDptvQhMH6ogZgyV6oNOCPY0CNf1R1M7lmMh6dBXLPRiJKp3CT34DU0YHEPDe7HHzvpA%3D%3D\\"}],\\"group\\":\\"cf-nel\\",\\"max_age\\":604800}",
                            "NEL": "{\\"success_fraction\\":0,\\"report_to\\":\\"cf-nel\\",\\"max_age\\":604800}",
                            "VARY": "Accept-Encoding",
                            "SERVER": "cloudflare",
                            "CF-RAY": "8abd34079e50a3aa-SEA",
                            "CONTENT-ENCODING": "gzip"
                        },
                        "filemagic": "HTML document, ASCII text, with very long lines",
                        "filetype": "text/html",
                        "fileclass": "HTML",
                        "cert": {
                            "issuer": {
                                "country_name": "US",
                                "organization_name": "Google Trust Services",
                                "common_name": "WE1"
                            },
                            "issuer_str": "Common Name: WE1, Organization: Google Trust Services, Country: US",
                            "subject": {
                                "common_name": "1312stealer.ru"
                            },
                            "subject_str": "Common Name: 1312stealer.ru",
                            "subject_alt_names": [
                                "1312stealer.ru",
                                "*.1312stealer.ru"
                            ],
                            "subject_alt_names_str": "1312stealer.ru, *.1312stealer.ru",
                            "fingerprint_sha1": "F2 24 62 B7 92 C3 76 19 74 6D 85 C2 57 2B 70 F8 A8 B5 86 20",
                            "fingerprint_sha256": "F0 F1 DE 8A 8E 9B CD E4 E7 AC 6D 23 B4 AD 65 4C 1A 5F 99 83 F9 48 A1 2C DC E2 FB 6E CB 3F 49 EA",
                            "public_key": "0411B20A53D9515370DFAA1B83E9B60D53F7CC35926C865AD158F3411E90D7F68C7C59BC394354F447122F4AFA51F04DE4F692B5B8F14A1565BE66382E13801364",
                            "public_key_str": "04 11 B2 0A 53 D9 51 53 70 DF AA 1B 83 E9 B6 0D 53 F7 CC 35 92 6C 86\\n5A D1 58 F3 41 1E 90 D7 F6 8C 7C 59 BC 39 43 54 F4 47 12 2F 4A FA 51\\nF0 4D E4 F6 92 B5 B8 F1 4A 15 65 BE 66 38 2E 13 80 13 64",
                            "public_key_parameters": "secp256r1",
                            "public_key_algorithm": "ec",
                            "public_key_size": 256,
                            "public_key_exponent": null,
                            "signature": "30460221008A36DD2EE6BD69CB960C980C50511F76736791ACA8CB9CC97D18FDA544C0F25802210091F8C930DA0A65A53B2DB64F523541FA61AF3C701B65FEC4EBC010127A4C4FAE",
                            "signature_str": "30 46 02 21 00 8A 36 DD 2E E6 BD 69 CB 96 0C 98 0C 50 51 1F 76 73 67\\n91 AC A8 CB 9C C9 7D 18 FD A5 44 C0 F2 58 02 21 00 91 F8 C9 30 DA 0A\\n65 A5 3B 2D B6 4F 52 35 41 FA 61 AF 3C 70 1B 65 FE C4 EB C0 10 12 7A\\n4C 4F AE",
                            "signature_algorithm": "sha256_ecdsa",
                            "x509_version": "v3",
                            "serial_number": "38162245235073902091222715175786048811",
                            "serial_number_str": "38162245235073902091222715175786048811",
                            "is_expired": false,
                            "is_self_signed": "no",
                            "is_self_issued": false,
                            "not_valid_before": "2024-07-22T22:26:27+00:00",
                            "not_valid_before_str": "2024-07-22 22:26:27+00:00",
                            "not_valid_after": "2024-10-20T22:26:26+00:00",
                            "not_valid_after_str": "2024-10-20 22:26:26+00:00",
                            "extensions": {
                                "keyUsage": "Digital Signature",
                                "extendedKeyUsage": "TLS Web Server Authentication",
                                "basicConstraints": "CA:FALSE",
                                "subjectKeyIdentifier": "F1:1A:0D:4A:40:37:B4:DC:06:EF:9D:66:0C:9B:FA:F5:D5:13:51:E1",
                                "authorityKeyIdentifier": "90:77:92:35:67:C4:FF:A8:CC:A9:E6:7B:D9:80:79:7B:CC:93:F9:38",
                                "authorityInfoAccess": "OCSP - URI:http://o.pki.goog/s/we1/HLU CA Issuers - URI:http://i.pki.goog/we1.crt",
                                "subjectAltName": "DNS:1312stealer.ru, DNS:*.1312stealer.ru",
                                "certificatePolicies": "Policy: 2.23.140.1.2.1",
                                "crlDistributionPoints": "Full Name:   URI:http://c.pki.goog/we1/BR1mWoHyxgA.crl",
                                "ct_precert_scts": "Signed Certificate Timestamp:\\n    Version   : v1 (0x0)\\n    Log ID    : DA:B6:BF:6B:3F:B5:B6:22:9F:9B:C2:BB:5C:6B:E8:70:\\n                91:71:6C:BB:51:84:85:34:BD:A4:3D:30:48:D7:FB:AB\\n    Timestamp : Jul 22 23:26:27.379 2024 GMT\\n    Extensions: none\\n    Signature : ecdsa-with-SHA256\\n                30:44:02:20:6C:78:4E:30:A3:8E:16:F0:6D:46:68:16:\\n                DC:86:5B:18:46:41:E8:67:23:39:BE:4A:5E:1B:E8:36:\\n                89:BF:67:4A:02:20:2B:A5:D6:77:D2:E3:93:AA:78:B8:\\n                63:96:BD:0F:9B:E9:AE:53:E7:74:C9:08:B1:27:F1:53:\\n                3B:A8:6A:AB:E3:42\nSigned Certificate Timestamp:\\n    Version   : v1 (0x0)\\n    Log ID    : 76:FF:88:3F:0A:B6:FB:95:51:C2:61:CC:F5:87:BA:34:\\n                B4:A4:CD:BB:29:DC:68:42:0A:9F:E6:67:4C:5A:3A:74\\n    Timestamp : Jul 22 23:26:27.372 2024 GMT\\n    Extensions: none\\n    Signature : ecdsa-with-SHA256\\n                30:45:02:20:2E:92:AB:D1:56:09:1E:10:12:83:52:28:\\n                BA:2C:7A:EF:6B:EA:77:6A:87:AA:4D:F9:BA:19:FE:6E:\\n                51:E1:1F:37:02:21:00:E1:0E:E7:F9:C0:6D:BA:22:B0:\\n                80:7B:B5:58:83:16:26:44:83:2D:71:29:52:48:BC:64:\\n                66:7F:AE:37:1F:A9:9B"
                            },
                            "https_validity": "valid"
                        },
                        "total_votes": {
                            "harmless": 0,
                            "malicious": 0
                        },
                        "detected_referrer_samples": [],
                        "detected_downloaded_samples": [],
                        "domain": "1312stealer.ru",
                        "last_analysis_date": 1722465800,
                        "registrar": "REGRU-RU"
                    },
                    "type": "domain",
                    "id": "4444477",
                    "links": {
                        "self": "https://www.virustotal.com/api/v3/domains/4444477"
                    }
                },
                "meta": {
                    "count": 0
                }
            }

--- WHOIS Data ---
{
  "domain_name": "1312stealer.ru",
  "registrar": "RU-CENTER-RU",
  "whois_server": "whois.ripn.net",
  "referral_url": "https://www.nic.ru/",
  "updated_date": null,
  "creation_date": "2024-07-22T21:23:58Z",
  "expiration_date": "2025-07-22T21:23:58Z",
  "last_updated": null,
  "status": "REGISTERED, DELEGATED, VERIFIED",
  "name_servers": [
    "AVA.NS.CLOUDFLARE.COM",
    "BILL.NS.CLOUDFLARE.COM"
  ],
  "name_servers_sort": [
    "ava.ns.cloudflare.com",
    "bill.ns.cloudflare.com"
  ],
  "registrar_abuse_contact_email": "abuse@nic.ru",
  "registrar_abuse_contact_phone": "+7.4957370601",
  "domain_name_ext": ".ru",
  "domain_name_idna": "1312stealer.ru",
  "whois_server_norm": "whois.ripn.net",
  "registrar_norm": "RU-CENTER-RU",
  "status_code": 200,
  "parse_code": 8,
  "stripped_text": "domain:    1312stealer.ru\nПоказывается только зарегистрированная версия.\n\nПоказатель истечения срока регистрации: free\nПоказатель продления: no\nnserver:     bill.ns.cloudflare.com.\nnserver:     ava.ns.cloudflare.com.\nstate:       REGISTERED, DELEGATED, VERIFIED\norg:         Private Person\nregistrar:   REGRU-RU\nadmin-contact: https://partner.r01.ru/contact.khtml\ncreated:     2024-07-22T21:23:58Z\npaid-till:   2025-07-22T21:23:58Z\nf изменился, использовать whoisClient.lookup.\n",
  "header": "Whois for 1312stealer.ru\n",
  "footer": "This query was served by the RU-CENTER WHOIS server."
}
                `;

                const dataBlocks = sampleData.split('--- ');
                let alienVaultData = null;
                let pulsediveData = null;
                let metaDefenderData = null;
                let securityTrailsData = null;
                let virusTotalData = null;
                let whoisData = null; // For WHOIS data

                dataBlocks.forEach(block => {
                    if (block.startsWith('AlienVault OTX Results')) {
                        try {
                            alienVaultData = JSON.parse(block.substring(block.indexOf('{')));
                            console.log("AlienVault Data Parsed:", alienVaultData);
                        } catch (e) {
                            console.error("Error parsing AlienVault Data:", e);
                        }
                    } else if (block.startsWith('Pulsedive Links')) {
                        try {
                            pulsediveData = JSON.parse(block.substring(block.indexOf('{')));
                            console.log("Pulsedive Data Parsed:", pulsediveData);
                        } catch (e) {
                            console.error("Error parsing Pulsedive Data:", e);
                        }
                    } else if (block.startsWith('MetaDefender Domain Info')) {
                        try {
                            metaDefenderData = JSON.parse(block.substring(block.indexOf('{')));
                            console.log("MetaDefender Data Parsed:", metaDefenderData);
                        } catch (e) {
                            console.error("Error parsing MetaDefender Data:", e);
                        }
                    } else if (block.startsWith('SecurityTrails DNS Records')) {
                        try {
                            securityTrailsData = JSON.parse(block.substring(block.indexOf('{')));
                            console.log("SecurityTrails Data Parsed:", securityTrailsData);
                        } catch (e) {
                            console.error("Error parsing SecurityTrails Data:", e);
                        }
                    } else if (block.startsWith('VirusTotal Domain Report')) {
                        try {
                            virusTotalData = JSON.parse(block.substring(block.indexOf('{')));
                            console.log("VirusTotal Data Parsed:", virusTotalData);
                        } catch (e) {
                            console.error("Error parsing VirusTotal Data:", e);
                        }
                    } else if (block.startsWith('WHOIS Data')) {
                        try {
                            whoisData = JSON.parse(block.substring(block.indexOf('{')));
                            console.log("WHOIS Data Parsed:", whoisData);
                        } catch (e) {
                            console.error("Error parsing WHOIS Data:", e);
                        }
                    }
                });


                const platformResults = [
                    {
                        name: 'VirusTotal',
                        status: 'Safe', // Placeholder - adjust logic based on VT data
                        threatScore: virusTotalData?.data?.attributes?.last_analysis_stats?.malicious || 0,
                        riskAssessment: 'Low Risk', // Placeholder - adjust logic based on VT data
                        lastAnalysisDate: virusTotalData?.data?.attributes?.last_modification_date ? new Date(virusTotalData.data.attributes.last_modification_date * 1000).toLocaleDateString() : 'N/A',
                        fullResponse: virusTotalData // Store full response for modal
                    },
                    {
                        name: 'AlienVault',
                        status: 'Malicious', // Placeholder - adjust logic based on AlienVault data
                        threatScore: 85, // Placeholder - adjust logic based on AlienVault data
                        riskAssessment: 'High Risk', // Placeholder - adjust logic based on AlienVault data
                        lastAnalysisDate: alienVaultData?.general?.date || 'N/A',
                        fullResponse: alienVaultData // Store full response for modal
                    },
                    {
                        name: 'Pulsedive',
                        status: 'Safe', // Placeholder - adjust logic based on Pulsedive data
                        threatScore: 5, // Placeholder - adjust logic based on Pulsedive data
                        riskAssessment: 'Low Risk', // Placeholder - adjust logic based on Pulsedive data
                        lastAnalysisDate: pulsediveData?.['Active DNS'] ? pulsediveData['Active DNS'][0]?.stamp_linked.split(' ')[0] : 'N/A', //Example, adjust based on desired date
                        fullResponse: pulsediveData // Store full response for modal
                    },
                    {
                        name: 'MetaDefender',
                        status: 'Suspicious', // Placeholder - adjust logic based on MetaDefender data
                        threatScore: 60, // Placeholder - adjust logic based on MetaDefender data
                        riskAssessment: 'Medium Risk', // Placeholder - adjust logic based on MetaDefender data
                        lastAnalysisDate: metaDefenderData?.lookup_results?.update_time ? new Date(metaDefenderData.lookup_results.update_time).toLocaleDateString() : 'N/A',
                        fullResponse: metaDefenderData // Store full response for modal
                    },
                    {
                        name: 'SecurityTrails',
                        status: 'Safe', // Placeholder - adjust logic based on SecurityTrails data
                        threatScore: 15, // Placeholder - adjust logic based on SecurityTrails data
                        riskAssessment: 'Low Risk', // Placeholder - adjust logic based on SecurityTrails data
                        lastAnalysisDate: securityTrailsData?.domainToolsVerification?.last_verified ? new Date(securityTrailsData.domainToolsVerification.last_verified).toLocaleDateString() : 'N/A',
                        fullResponse: securityTrailsData // Store full response for modal
                    }
                ];


                // WHOIS data extraction - using the dedicated WHOIS data block now
                const whois = {
                    registrar: whoisData?.registrar || 'N/A',
                    registrationDate: whoisData?.creation_date || 'N/A',
                    expirationDate: whoisData?.expiration_date || 'N/A',
                    contactEmail: whoisData?.registrar_abuse_contact_email || 'N/A', // Example, adjust based on actual WHOIS data structure
                    additionalData: {
                        'WHOIS Server': whoisData?.whois_server || 'N/A',
                        'Updated Date': whoisData?.updated_date || 'N/A',
                        'Status': whoisData?.status || 'N/A',
                        // Add more WHOIS fields as needed and available in your sample
                    }
                };


                this.results = {
                    domain: this.domain,
                    quickStats: {
                        threatScore: platformResults.reduce((sum, p) => sum + (p.threatScore || 0), 0), // Aggregate threat score
                        riskScore: 70, // Placeholder - calculate overall risk score based on platform statuses/scores
                    },
                    whois: whois,
                    platforms: platformResults
                };


                this.loading = false;
            },
            openModal(platform) { // Keep modal function, but it's not used in this tabbed UI currently
                this.isModalOpen = true;
                this.selectedPlatform = platform;
                this.fullResponseData = JSON.stringify(platform.fullResponse, null, 2); // Pretty print JSON for modal
            },
            closeModal() { // Keep modal function
                this.isModalOpen = false;
                this.selectedPlatform = null;
                this.fullResponseData = '';
            }
        }));
    });
</script>
{% endblock %}