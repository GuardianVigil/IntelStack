{% extends 'components/layouts/default.html' %}

{% load static %}

{% block content %}
<div x-data="emailAnalysis">
    <ul class="flex space-x-2 rtl:space-x-reverse">
        <li>
            <a href="/" class="text-primary hover:underline">Dashboard</a>
        </li>
        <li class="before:content-['/'] ltr:before:mr-1 rtl:before:ml-1">
            <span>Email Investigation</span>
        </li>
    </ul>

    <div class="pt-5">
        <div class="panel">
            <!-- Input Section -->
            <div class="flex items-center justify-between mb-5">
                <h5 class="font-semibold text-lg dark:text-white-light">Email Analysis</h5>
                <div class="flex items-center">
                    <button @click="clearForm" class="btn btn-outline-danger ltr:ml-2">Clear</button>
                </div>
            </div>

            <!-- File Upload & Input Section -->
            <div class="mb-5">
                <form @submit.prevent="analyzeEmail" class="space-y-5">
                    <div class="grid grid-cols-1 gap-4">
                        <!-- Drag & Drop Zone -->
                        <div class="border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg p-6 text-center" 
                             @dragover.prevent="dragOver"
                             @dragleave.prevent="dragLeave"
                             @drop.prevent="handleDrop">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Drag and drop .eml or .msg files here</p>
                                <p class="text-xs text-gray-500">or</p>
                                <label class="btn btn-primary mt-2 cursor-pointer">
                                    <span>Choose File</span>
                                    <input type="file" class="hidden" @change="handleFileUpload" accept=".eml,.msg">
                                </label>
                            </div>
                        </div>

                        <!-- Email Header Input -->
                        <div>
                            <label for="emailContent">Email Headers or Content</label>
                            <textarea id="emailContent" rows="8" placeholder="Paste email headers or content here" 
                                    class="form-textarea" x-model="emailContent"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-full">Analyze Email</button>
                </form>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="flex justify-center mt-10">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
            </div>

            <!-- Results Section -->
            <div x-show="!loading && results" class="space-y-5 mt-10">
                <!-- Quick Stats Dashboard -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Threat Score -->
                    <div class="panel bg-gradient-to-r from-blue-500 to-blue-400 text-white">
                        <div class="flex justify-between">
                            <div>
                                <h5 class="text-xl font-semibold mb-1">Threat Score</h5>
                                <p class="text-3xl" x-text="results.threatScore + '/100'"></p>
                            </div>
                            <div class="text-right">
                                <span class="text-sm" x-text="results.riskLevel"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Authentication Status -->
                    <div class="panel">
                        <h5 class="font-semibold mb-2">Authentication</h5>
                        <div class="flex space-x-2">
                            <span class="badge" :class="{
                                'badge-outline-success': results.authentication.spf === 'pass',
                                'badge-outline-danger': results.authentication.spf === 'fail'
                            }">SPF</span>
                            <span class="badge" :class="{
                                'badge-outline-success': results.authentication.dkim === 'pass',
                                'badge-outline-danger': results.authentication.dkim === 'fail'
                            }">DKIM</span>
                            <span class="badge" :class="{
                                'badge-outline-success': results.authentication.dmarc === 'pass',
                                'badge-outline-danger': results.authentication.dmarc === 'fail'
                            }">DMARC</span>
                        </div>
                    </div>

                    <!-- Threats Detected -->
                    <div class="panel">
                        <h5 class="font-semibold mb-2">Threats Detected</h5>
                        <div class="space-y-1">
                            <p>
                                <span class="text-danger" x-text="results.threats_detected.suspicious_ips"></span> Suspicious IPs
                            </p>
                            <p>
                                <span class="text-danger" x-text="results.threats_detected.malicious_urls"></span> Malicious URLs
                            </p>
                            <p>
                                <span class="text-danger" x-text="results.threats_detected.suspicious_attachments"></span> Suspicious Attachments
                            </p>
                        </div>
                    </div>

                    <!-- Risk Indicators -->
                    <div class="panel">
                        <h5 class="font-semibold mb-2">Risk Indicators</h5>
                        <div class="space-y-1">
                            <div class="flex justify-between">
                                <span>Phishing Probability</span>
                                <span x-text="(results.indicators.phishing_probability * 100).toFixed(1) + '%'"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Spam Score</span>
                                <span x-text="(results.indicators.spam_score * 100).toFixed(1) + '%'"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis Tabs -->
                <div class="panel">
                    <div class="mb-5 border-b border-[#ebedf2] dark:border-[#191e3a]">
                        <div class="flex flex-wrap gap-2">
                            <button type="button" 
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'headerAnalysis',
                                            'text-black dark:text-white-dark': activeTab !== 'headerAnalysis'}"
                                    @click="activeTab = 'headerAnalysis'">
                                Header Analysis
                            </button>
                            <button type="button"
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'ipAnalysis',
                                            'text-black dark:text-white-dark': activeTab !== 'ipAnalysis'}"
                                    @click="activeTab = 'ipAnalysis'">
                                IP Analysis
                            </button>
                            <button type="button"
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'urlAnalysis',
                                            'text-black dark:text-white-dark': activeTab !== 'urlAnalysis'}"
                                    @click="activeTab = 'urlAnalysis'">
                                URL Analysis
                            </button>
                            <button type="button"
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'attachments',
                                            'text-black dark:text-white-dark': activeTab !== 'attachments'}"
                                    @click="activeTab = 'attachments'">
                                Attachments
                            </button>
                            <button type="button"
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'timeline',
                                            'text-black dark:text-white-dark': activeTab !== 'timeline'}"
                                    @click="activeTab = 'timeline'">
                                Timeline
                            </button>
                        </div>
                    </div>

                    <!-- Header Analysis Tab -->
                    <div x-show="activeTab === 'headerAnalysis'" class="p-4">
                        <div class="mb-5">
                            <h6 class="text-lg font-bold mb-2">Email Headers</h6>
                            <div class="overflow-x-auto">
                                <table class="table-striped w-full">
                                    <tbody>
                                        <template x-for="(value, key) in results.header_analysis" :key="key">
                                            <tr>
                                                <td class="font-semibold" x-text="key"></td>
                                                <td x-text="value"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Message Path Visualization -->
                        <div class="mb-5">
                            <h6 class="text-lg font-bold mb-2">Message Path</h6>
                            <div id="messagePath" class="h-64"></div>
                        </div>
                    </div>

                    <!-- IP Analysis Tab -->
                    <div x-show="activeTab === 'ipAnalysis'" class="p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- IP Geolocation Map -->
                            <div class="panel">
                                <h6 class="text-lg font-bold mb-2">IP Geolocation</h6>
                                <div id="geoMap" class="h-64"></div>
                            </div>

                            <!-- IP Details -->
                            <div class="panel">
                                <h6 class="text-lg font-bold mb-2">IP Information</h6>
                                <div class="space-y-2">
                                    <template x-for="ip in results.ip_analysis" :key="ip.address">
                                        <div class="p-4 border rounded">
                                            <p><strong>IP:</strong> <span x-text="ip.address"></span></p>
                                            <p><strong>Location:</strong> <span x-text="ip.location"></span></p>
                                            <p><strong>ASN:</strong> <span x-text="ip.asn"></span></p>
                                            <p><strong>Reputation:</strong> <span x-text="ip.reputation"></span></p>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- URL Analysis Tab -->
                    <div x-show="activeTab === 'urlAnalysis'" class="p-4">
                        <div class="space-y-4">
                            <template x-for="url in results.urls" :key="url.url">
                                <div class="panel">
                                    <h6 class="text-lg font-bold mb-2" x-text="url.url"></h6>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <p><strong>Reputation:</strong> <span x-text="url.reputation"></span></p>
                                            <p><strong>Category:</strong> <span x-text="url.category"></span></p>
                                            <p><strong>SSL Valid:</strong> <span x-text="url.ssl_valid"></span></p>
                                        </div>
                                        <div>
                                            <img :src="url.screenshot" alt="URL Preview" class="w-full rounded">
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Attachments Tab -->
                    <div x-show="activeTab === 'attachments'" class="p-4">
                        <div class="space-y-4">
                            <template x-for="attachment in results.attachments" :key="attachment.hash">
                                <div class="panel">
                                    <div class="flex items-center justify-between mb-4">
                                        <h6 class="text-lg font-bold" x-text="attachment.filename"></h6>
                                        <span class="badge" :class="{
                                            'badge-outline-success': attachment.verdict === 'clean',
                                            'badge-outline-danger': attachment.verdict === 'malicious',
                                            'badge-outline-warning': attachment.verdict === 'suspicious'
                                        }" x-text="attachment.verdict"></span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <p><strong>Type:</strong> <span x-text="attachment.type"></span></p>
                                            <p><strong>Size:</strong> <span x-text="attachment.size"></span></p>
                                            <p><strong>MD5:</strong> <span x-text="attachment.md5"></span></p>
                                            <p><strong>SHA256:</strong> <span x-text="attachment.sha256"></span></p>
                                        </div>
                                        <div>
                                            <h6 class="font-semibold mb-2">Threat Intel Results</h6>
                                            <template x-for="(result, source) in attachment.threat_intel" :key="source">
                                                <div class="flex justify-between">
                                                    <span x-text="source"></span>
                                                    <span x-text="result"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Timeline Tab -->
                    <div x-show="activeTab === 'timeline'" class="p-4">
                        <div id="emailTimeline" class="h-96"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("alpine:init", () => {
        Alpine.data("emailAnalysis", () => ({
            emailContent: "",
            loading: false,
            results: null,
            activeTab: 'headerAnalysis',
            
            init() {
                this.$watch('results', () => {
                    if (this.results) {
                        this.initializeVisualizations();
                    }
                });
            },

            clearForm() {
                this.emailContent = "";
                this.results = null;
                this.loading = false;
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processFile(file);
                }
            },

            handleDrop(event) {
                const file = event.dataTransfer.files[0];
                if (file) {
                    this.processFile(file);
                }
            },

            dragOver(event) {
                event.target.classList.add('border-primary');
            },

            dragLeave(event) {
                event.target.classList.remove('border-primary');
            },

            async processFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.emailContent = e.target.result;
                };
                reader.readAsText(file);
            },

            async analyzeEmail() {
                if (!this.emailContent) return;

                this.loading = true;
                try {
                    // Simulated API response with sample data
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API delay
                    
                    this.results = {
                        threatScore: 85,
                        riskLevel: "High",
                        authentication: {
                            spf: "pass",
                            dkim: "fail",
                            dmarc: "none"
                        },
                        threats_detected: {
                            suspicious_ips: 2,
                            malicious_urls: 1,
                            suspicious_attachments: 1
                        },
                        indicators: {
                            phishing_probability: 0.92,
                            spam_score: 0.3,
                            brand_impersonation: true
                        },
                        header_analysis: {
                            "From": "PayPal Security <security@paypa1.com>",
                            "Return-Path": "<bounce@paypa1.com>",
                            "Reply-To": "support@paypa1.com",
                            "Subject": "Urgent: Your PayPal account needs attention",
                            "Date": "Thu, 21 Feb 2025 17:28:18 +0000",
                            "Message-ID": "<1234567890@mail-server>",
                            "X-Sender": "mail-server.paypa1.com",
                            "X-Mailer": "PHPMailer 6.0.1"
                        },
                        ip_analysis: [
                            {
                                address: "192.168.1.100",
                                location: "Moscow, Russia",
                                asn: "AS12345 - Suspicious Host Ltd",
                                reputation: "Poor - Known Spam Source"
                            },
                            {
                                address: "10.20.30.40",
                                location: "Beijing, China",
                                asn: "AS67890 - Malicious Network Corp",
                                reputation: "Bad - Multiple Reports"
                            }
                        ],
                        urls: [
                            {
                                url: "https://paypa1.com/secure/login",
                                reputation: "Malicious",
                                category: "Phishing",
                                ssl_valid: "Invalid Certificate",
                                screenshot: "https://via.placeholder.com/300x200"
                            },
                            {
                                url: "https://account-verification.paypa1.com",
                                reputation: "Suspicious",
                                category: "Newly Registered Domain",
                                ssl_valid: "Self-signed Certificate",
                                screenshot: "https://via.placeholder.com/300x200"
                            }
                        ],
                        attachments: [
                            {
                                filename: "PayPal_Statement.pdf",
                                type: "PDF Document",
                                size: "245 KB",
                                verdict: "malicious",
                                md5: "d41d8cd98f00b204e9800998ecf8427e",
                                sha256: "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
                                threat_intel: {
                                    "VirusTotal": "20/68 Detections",
                                    "Hybrid Analysis": "Malicious",
                                    "Malware Bazaar": "Known Malware"
                                }
                            },
                            {
                                filename: "Account_Details.xlsx",
                                type: "Excel Document",
                                size: "132 KB",
                                verdict: "suspicious",
                                md5: "a87ff679a2f3e71d9181a67b7542122c",
                                sha256: "7f83b1657ff1fc53b92dc18148a1d65dfc2d4b1fa3d677284addd200126d9069",
                                threat_intel: {
                                    "VirusTotal": "3/68 Detections",
                                    "Hybrid Analysis": "Suspicious",
                                    "Malware Bazaar": "No Match"
                                }
                            }
                        ]
                    };
                } catch (error) {
                    console.error('Analysis failed:', error);
                    // Show error notification
                } finally {
                    this.loading = false;
                }
            },

            initializeVisualizations() {
                // Initialize D3.js visualizations
                this.initMessagePath();
                this.initGeoMap();
                this.initTimeline();
            },

            initMessagePath() {
                // D3.js code for message path visualization
            },

            initGeoMap() {
                // D3.js code for geographical map
            },

            initTimeline() {
                // D3.js code for email timeline
            },

            async exportPDF() {
                // PDF export logic
            },

            async exportCSV() {
                // CSV export logic
            },

            async exportJSON() {
                // JSON export logic
            },

            async exportIOC() {
                // IOC export logic
            }
        }));
    });
</script>
{% endblock %}