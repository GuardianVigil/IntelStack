{% extends 'components/layouts/default.html' %}

{% load static %}

{% block content %}
<div x-data="emailAnalysis">
    <ul class="flex space-x-2 rtl:space-x-reverse">
        <li>
            <a href="/" class="text-primary hover:underline">Dashboard</a>
        </li>
        <li class="before:content-['/'] ltr:before:mr-1 rtl:before:ml-1">
            <span>Email Investigation</span>
        </li>
    </ul>

    <div class="pt-5">
        <div class="panel">
            <!-- Input Section -->
            <div class="flex items-center justify-between mb-5">
                <h5 class="font-semibold text-lg dark:text-white-light">Email Analysis</h5>
                <div class="flex items-center">
                    <button @click="clearForm" class="btn btn-outline-danger ltr:ml-2">Clear</button>
                </div>
            </div>

            <!-- File Upload & Input Section -->
            <div class="mb-5">
                <form @submit.prevent="analyzeEmail" class="space-y-5">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 gap-4">
                        <!-- Drag & Drop Zone -->
                        <div class="border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg p-6 text-center" 
                             @dragover.prevent="dragOver"
                             @dragleave.prevent="dragLeave"
                             @drop.prevent="handleDrop">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Drag and drop .eml or .msg files here</p>
                                <p class="text-xs text-gray-500">or</p>
                                <label class="btn btn-primary mt-2 cursor-pointer">
                                    <span>Choose File</span>
                                    <input type="file" class="hidden" @change="handleFileUpload" accept=".eml,.msg">
                                </label>
                            </div>
                        </div>

                        <!-- Email Header Input -->
                        <div>
                            <label for="emailContent">Email Headers or Content</label>
                            <textarea id="emailContent" rows="8" placeholder="Paste email headers or content here" 
                                    class="form-textarea" x-model="emailContent"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-full">Analyze Email</button>
                </form>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="flex justify-center mt-10">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
            </div>

            <!-- Results Section -->
            <div x-show="!loading && results" class="space-y-5 mt-10">
                <!-- Quick Stats Dashboard -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Threat Score -->
                    <div class="panel bg-gradient-to-r from-blue-500 to-blue-400 text-white">
                        <div class="flex justify-between">
                            <div>
                                <h5 class="text-xl font-semibold mb-1">Threat Score</h5>
                                <p class="text-3xl" x-text="results.risk_assessment.threat_score + '/100'"></p>
                            </div>
                            <div class="text-right">
                                <span class="text-sm" x-text="results.risk_assessment.risk_level"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Authentication Status -->
                    <div class="panel">
                        <h5 class="font-semibold mb-2">Authentication</h5>
                        <div class="flex space-x-2">
                            <span class="badge" :class="{
                                'badge-outline-success': results.authentication.spf === 'pass',
                                'badge-outline-danger': results.authentication.spf === 'fail',
                                'badge-outline-warning': results.authentication.spf === 'neutral'
                            }" x-text="results.authentication.spf"></span>
                            <span class="badge" :class="{
                                'badge-outline-success': results.authentication.dkim === 'pass',
                                'badge-outline-danger': results.authentication.dkim === 'fail',
                                'badge-outline-warning': results.authentication.dkim === 'neutral'
                            }" x-text="results.authentication.dkim"></span>
                            <span class="badge" :class="{
                                'badge-outline-success': results.authentication.dmarc === 'pass',
                                'badge-outline-danger': results.authentication.dmarc === 'fail',
                                'badge-outline-warning': results.authentication.dmarc === 'neutral'
                            }" x-text="results.authentication.dmarc"></span>
                        </div>
                    </div>

                    <!-- Threats Detected -->
                    <div class="panel">
                        <h5 class="font-semibold mb-2">Threats Detected</h5>
                        <div class="space-y-1">
                            <p>
                                <span class="text-danger" x-text="results.risk_assessment.indicators.suspicious_sender ? 1 : 0"></span> Suspicious IPs
                            </p>
                            <p>
                                <span class="text-danger" x-text="results.risk_assessment.indicators.suspicious_urls"></span> Malicious URLs
                            </p>
                            <p>
                                <span class="text-danger" x-text="results.risk_assessment.indicators.malicious_attachments"></span> Suspicious Attachments
                            </p>
                        </div>
                    </div>

                    <!-- Risk Indicators -->
                    <div class="panel">
                        <h5 class="font-semibold mb-2">Risk Factors</h5>
                        <div class="space-y-1">
                            <template x-for="factor in results.risk_assessment.risk_factors" :key="factor">
                                <div class="flex items-center text-danger">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    <span x-text="factor"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis Tabs -->
                <div class="panel">
                    <div class="mb-5 border-b border-[#ebedf2] dark:border-[#191e3a]">
                        <div class="flex flex-wrap gap-2">
                            <button type="button" 
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'headerAnalysis',
                                            'text-black dark:text-white-dark': activeTab !== 'headerAnalysis'}"
                                    @click="activeTab = 'headerAnalysis'">
                                Header Analysis
                            </button>
                            <button type="button"
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'ipAnalysis',
                                            'text-black dark:text-white-dark': activeTab !== 'ipAnalysis'}"
                                    @click="activeTab = 'ipAnalysis'">
                                IP Analysis
                            </button>
                            <button type="button"
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'urlAnalysis',
                                            'text-black dark:text-white-dark': activeTab !== 'urlAnalysis'}"
                                    @click="activeTab = 'urlAnalysis'">
                                URL Analysis
                            </button>
                            <button type="button"
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'attachments',
                                            'text-black dark:text-white-dark': activeTab !== 'attachments'}"
                                    @click="activeTab = 'attachments'">
                                Attachments
                            </button>
                            <button type="button"
                                    class="p-3.5 py-2 -mb-[1px] hover:text-primary"
                                    :class="{'text-primary !border-b !border-primary': activeTab === 'timeline',
                                            'text-black dark:text-white-dark': activeTab !== 'timeline'}"
                                    @click="activeTab = 'timeline'">
                                Timeline
                            </button>
                        </div>
                    </div>

                    <!-- Header Analysis Tab -->
                    <div x-show="activeTab === 'headerAnalysis'" class="p-4">
                        <div class="space-y-4">
                            <template x-for="(value, key) in results.headers.headers" :key="key">
                                <div class="panel">
                                    <h6 class="font-semibold mb-2" x-text="key"></h6>
                                    <p class="text-sm break-all" x-text="value"></p>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- IP Analysis Tab -->
                    <div x-show="activeTab === 'ipAnalysis'" class="p-4">
                        <div class="panel">
                            <template x-if="results.sender_ip">
                                <div>
                                    <h6 class="font-semibold mb-2">Sender IP</h6>
                                    <p class="text-sm" x-text="results.sender_ip.ip"></p>
                                    <div class="mt-2">
                                        <span class="badge" :class="{
                                            'badge-outline-success': results.sender_ip.reputation === 'clean',
                                            'badge-outline-warning': results.sender_ip.reputation === 'suspicious',
                                            'badge-outline-danger': results.sender_ip.reputation === 'malicious'
                                        }" x-text="results.sender_ip.reputation"></span>
                                    </div>
                                    <template x-if="results.sender_ip.geolocation">
                                        <div class="mt-4">
                                            <h6 class="font-semibold mb-2">Geolocation</h6>
                                            <p class="text-sm">
                                                <span x-text="results.sender_ip.geolocation.city"></span>,
                                                <span x-text="results.sender_ip.geolocation.region"></span>,
                                                <span x-text="results.sender_ip.geolocation.country"></span>
                                            </p>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- URL Analysis Tab -->
                    <div x-show="activeTab === 'urlAnalysis'" class="p-4">
                        <div class="space-y-4">
                            <template x-for="url in results.urls" :key="url.url">
                                <div class="panel">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold break-all" x-text="url.url"></h6>
                                        <span class="badge" :class="{
                                            'badge-outline-success': !url.malicious,
                                            'badge-outline-danger': url.malicious
                                        }" x-text="url.malicious ? 'Malicious' : 'Clean'"></span>
                                    </div>
                                    <template x-if="url.analysis">
                                        <div class="mt-2 space-y-2">
                                            <template x-for="(result, scanner) in url.analysis" :key="scanner">
                                                <div class="text-sm">
                                                    <span class="font-semibold" x-text="scanner + ': '"></span>
                                                    <span x-text="JSON.stringify(result)"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Attachments Tab -->
                    <div x-show="activeTab === 'attachments'" class="p-4">
                        <div class="space-y-4">
                            <template x-for="attachment in results.attachments" :key="attachment.hash">
                                <div class="panel">
                                    <div class="flex items-center justify-between mb-4">
                                        <h6 class="text-lg font-bold" x-text="attachment.filename"></h6>
                                        <span class="badge" :class="{
                                            'badge-outline-success': attachment.verdict === 'clean',
                                            'badge-outline-danger': attachment.verdict === 'malicious',
                                            'badge-outline-warning': attachment.verdict === 'suspicious'
                                        }" x-text="attachment.verdict"></span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <p><strong>Type:</strong> <span x-text="attachment.type"></span></p>
                                            <p><strong>Size:</strong> <span x-text="attachment.size"></span></p>
                                            <p><strong>MD5:</strong> <span x-text="attachment.md5"></span></p>
                                            <p><strong>SHA256:</strong> <span x-text="attachment.sha256"></span></p>
                                        </div>
                                        <div>
                                            <h6 class="font-semibold mb-2">Threat Intel Results</h6>
                                            <template x-for="(result, source) in attachment.threat_intel" :key="source">
                                                <div class="flex justify-between">
                                                    <span x-text="source"></span>
                                                    <span x-text="result"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Timeline Tab -->
                    <div x-show="activeTab === 'timeline'" class="p-4">
                        <div id="emailTimeline" class="h-96"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("alpine:init", () => {
        Alpine.data("emailAnalysis", () => ({
            emailContent: "",
            loading: false,
            results: null,
            activeTab: 'headerAnalysis',
            
            init() {
                this.$watch('results', () => {
                    if (this.results) {
                        this.initializeVisualizations();
                    }
                });
            },

            clearForm() {
                this.emailContent = "";
                this.results = null;
                this.loading = false;
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processFile(file);
                }
            },

            handleDrop(event) {
                const file = event.dataTransfer.files[0];
                if (file) {
                    this.processFile(file);
                }
            },

            dragOver(event) {
                event.target.classList.add('border-primary');
            },

            dragLeave(event) {
                event.target.classList.remove('border-primary');
            },

            async processFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.emailContent = e.target.result;
                };
                reader.readAsText(file);
            },

            async analyzeEmail() {
                console.log('Starting email analysis...');
                if (!this.emailContent) {
                    console.log('No email content provided');
                    return;
                }

                this.loading = true;
                console.log('Sending request to backend...');
                try {
                    const requestData = {
                        emailContent: this.emailContent,
                        attachments: [] // TODO: Implement attachment handling
                    };
                    console.log('Request data:', requestData);

                    const response = await fetch('/threat/email-investigation/analyze/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify(requestData)
                    });

                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to analyze email');
                    }

                    this.results = await response.json();
                    console.log('Analysis results:', this.results);
                    this.initializeVisualizations();
                } catch (error) {
                    console.error('Error:', error);
                    // Show error to user
                    const toast = window.$store.app.toast({
                        message: error.message || 'An error occurred while analyzing the email',
                        type: 'error'
                    });
                } finally {
                    this.loading = false;
                }
            },

            initializeVisualizations() {
                // Initialize D3.js visualizations
                this.initMessagePath();
                this.initGeoMap();
                this.initTimeline();
            },

            initMessagePath() {
                // D3.js code for message path visualization
            },

            initGeoMap() {
                // D3.js code for geographical map
            },

            initTimeline() {
                // D3.js code for email timeline
            },

            async exportPDF() {
                // PDF export logic
            },

            async exportCSV() {
                // CSV export logic
            },

            async exportJSON() {
                // JSON export logic
            },

            async exportIOC() {
                // IOC export logic
            }
        }));
    });
</script>
{% endblock %}