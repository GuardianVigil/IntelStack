{% extends 'components/layouts/default.html' %}

{% load static %}

{% block content %}
<div x-data="emailAnalysis">
    <ul class="flex space-x-2 rtl:space-x-reverse">
        <li>
            <a href="/" class="text-primary hover:underline">Dashboard</a>
        </li>
        <li class="before:content-['/'] ltr:before:mr-1 rtl:before:ml-1">
            <span>Email Investigation</span>
        </li>
    </ul>

    <div class="pt-5">
        <div class="panel">
            <div class="flex items-center justify-between mb-5">
                <h5 class="font-semibold text-lg dark:text-white-light">Email Analysis</h5>
            </div>

            <div class="mb-5">
                <form @submit.prevent="analyzeEmail" class="space-y-5">
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="emailContent">Email Headers or Content</label>
                            <textarea id="emailContent" rows="10" placeholder="Paste email headers or content here" class="form-textarea" x-model="emailContent"></textarea>
                        </div>
                        <div>
                            <label for="emailFile" class="btn btn-outline-primary">Upload Email File</label>
                            <input type="file" id="emailFile" @change="handleFileUpload" class="hidden">
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit" class="btn btn-primary">Analyze</button>
                        <button type="button" @click="clearForm" class="btn btn-outline-danger">Clear</button>
                    </div>
                </form>
            </div>

            <div x-show="loading" class="flex justify-center mt-10">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
            </div>

            <div x-show="!loading && results" class="space-y-5 mt-10">
                <!-- Quick Stats -->
                <div class="panel grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <h6 class="text-lg font-bold mb-2">Threat Score</h6>
                        <span class="text-2xl" x-text="results.threatScore"></span>
                    </div>
                    <div class="text-center">
                        <h6 class="text-lg font-bold mb-2">Confidence</h6>
                        <span class="text-2xl" x-text="results.confidence"></span>
                    </div>
                    <div class="text-center">
                        <h6 class="text-lg font-bold mb-2">Risk Indicator</h6>
                        <div class="flex justify-center space-x-2">
                            <span class="badge badge-outline-success" x-text="results.riskIndicators.low"></span>
                            <span class="badge badge-outline-warning" x-text="results.riskIndicators.medium"></span>
                            <span class="badge badge-outline-danger" x-text="results.riskIndicators.high"></span>
                        </div>
                    </div>
                </div>

                <!-- Header Analysis -->
                <div class="panel">
                    <h6 class="text-lg font-bold mb-2">Header Analysis</h6>
                    <div class="table-responsive">
                        <table class="table-striped">
                            <tbody>
                                <tr>
                                    <td class="font-semibold">From:</td>
                                    <td x-text="results.from"></td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">Return Path:</td>
                                    <td x-text="results.returnPath"></td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">SPF:</td>
                                    <td>
                                        <span class="badge" :class="{
                                            'badge-outline-success': results.spf === 'Pass',
                                            'badge-outline-danger': results.spf === 'Fail'
                                        }" x-text="results.spf"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">DKIM:</td>
                                    <td>
                                        <span class="badge" :class="{
                                            'badge-outline-success': results.dkim === 'Pass',
                                            'badge-outline-danger': results.dkim === 'Fail'
                                        }" x-text="results.dkim"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">DMARC:</td>
                                    <td>
                                        <span class="badge" :class="{
                                            'badge-outline-success': results.dmarc === 'Pass',
                                            'badge-outline-danger': results.dmarc === 'Fail'
                                        }" x-text="results.dmarc"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">Alignment:</td>
                                    <td x-text="results.alignment"></td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">Spoofing Detection:</td>
                                    <td x-text="results.spoofingDetection"></td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">Hop Analysis:</td>
                                    <td>
                                        <ul>
                                            <template x-for="hop in results.hopAnalysis" :key="hop.id">
                                                <li x-text="hop.timestamp + ' - ' + hop.description"></li>
                                            </template>
                                        </ul>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Threat Intelligence -->
                <div class="panel">
                    <h6 class="text-lg font-bold mb-2">Threat Intelligence</h6>
                    <div class="space-y-4">
                        <div>
                            <h6 class="font-semibold mb-2">IP Analysis</h6>
                            <table class="table-striped">
                                <tbody>
                                    <tr>
                                        <td class="font-semibold">GeoIP Location:</td>
                                        <td x-text="results.ipAnalysis.geoIpLocation"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Reverse DNS:</td>
                                        <td x-text="results.ipAnalysis.reverseDns"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Reputation:</td>
                                        <td x-text="results.ipAnalysis.reputation"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">ASN Information:</td>
                                        <td x-text="results.ipAnalysis.asnInformation"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Historical Data:</td>
                                        <td x-text="results.ipAnalysis.historicalData"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold">Malicious IP:</td>
                                        <td>
                                            <span class="badge" :class="{
                                                'badge-outline-success': !results.ipAnalysis.isMalicious,
                                                'badge-outline-danger': results.ipAnalysis.isMalicious
                                            }">
                                                <template x-if="results.ipAnalysis.isMalicious">
                                                    Malicious (<span x-text="results.ipAnalysis.maliciousPlatforms.join(', ')"></span>)
                                                </template>
                                                <template x-if="!results.ipAnalysis.isMalicious">
                                                    Not Malicious
                                                </template>
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h6 class="font-semibold mb-2">WHOIS Domain Lookup</h6>
                                <div class="p-4 border rounded-md">
                                    <pre x-text="results.whoisDomainLookup"></pre>
                                </div>
                            </div>
                            <div>
                                <h6 class="font-semibold mb-2">Blocklist Verification</h6>
                                <div class="p-4 border rounded-md">
                                    <span x-text="results.blocklistVerification"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- URL & Attachment Analysis -->
                <div class="panel">
                    <h6 class="text-lg font-bold mb-2">Detected IOCs</h6>
                    <div class="space-y-4">
                        <div>
                            <h6 class="font-semibold mb-2">URLs</h6>
                            <div class="overflow-x-auto">
                                <table class="table-striped w-full">
                                    <thead>
                                        <tr>
                                            <th>URL</th>
                                            <th>Status</th>
                                            <th>Reputation</th>
                                            <th>Domain Age</th>
                                            <th>SSL Validation</th>
                                            <th>Landing Page Analysis</th>
                                            <th>Redirection Detection</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(url, index) in results.urls" :key="index">
                                            <tr>
                                                <td x-text="url.url"></td>
                                                <td>
                                                    <span class="badge" :class="{
                                                        'badge-outline-success': url.status === 'Clean',
                                                        'badge-outline-warning': url.status === 'Suspicious',
                                                        'badge-outline-danger': url.status === 'Malicious'
                                                    }" x-text="url.status"></span>
                                                </td>
                                                <td x-text="url.reputation"></td>
                                                <td x-text="url.domainAge"></td>
                                                <td x-text="url.sslValidation"></td>
                                                <td x-text="url.landingPageAnalysis"></td>
                                                <td x-text="url.redirectionDetection"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div></div>
                        <div>
                            <h6 class="font-semibold mb-2">Attachments</h6>
                            <div class="overflow-x-auto">
                                <table class="table-striped w-full">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Status</th>
                                            <th>Hash (MD5)</th>
                                            <th>Hash (SHA-1)</th>
                                            <th>Hash (SHA-256)</th>
                                            <th>File Type</th>
                                            <th>Static Analysis</th>
                                            <th>Sandbox Analysis</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(attachment, index) in results.attachments" :key="index">
                                            <tr>
                                                <td x-text="attachment.name"></td>
                                                <td>
                                                    <span class="badge" :class="{
                                                        'badge-outline-success': attachment.status === 'Clean',
                                                        'badge-outline-warning': attachment.status === 'Suspicious',
                                                        'badge-outline-danger': attachment.status === 'Malicious'
                                                    }" x-text="attachment.status"></span>
                                                </td>
                                                <td x-text="attachment.hashMd5"></td>
                                                <td x-text="attachment.hashSha1"></td>
                                                <td x-text="attachment.hashSha256"></td>
                                                <td x-text="attachment.fileType"></td>
                                                <td x-text="attachment.staticAnalysis"></td>
                                                <td x-text="attachment.sandboxAnalysis"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phishing & Fraud Detection -->
                <div class="panel">
                    <h6 class="text-lg font-bold mb-2">Phishing & Fraud Detection</h6>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h6 class="font-semibold mb-2">Display Name Spoofing</h6>
                            <div class="p-4 border rounded-md">
                                <span x-text="results.displayNameSpoofing"></span>
                            </div>
                        </div>
                        <div>
                            <h6 class="font-semibold mb-2">Look-alike Domain Detection</h6>
                            <div class="p-4 border rounded-md">
                                <span x-text="results.lookAlikeDomainDetection"></span>
                            </div>
                        </div>
                        <div>
                            <h6 class="font-semibold mb-2">Phishing Keyword Analysis</h6>
                            <div class="p-4 border rounded-md">
                                <span x-text="results.phishingKeywordAnalysis"></span>
                            </div>
                        </div>
                        <div>
                            <h6 class="font-semibold mb-2">Urgency Indicator Checks</h6>
                            <div class="p-4 border rounded-md">
                                <span x-text="results.urgencyIndicatorChecks"></span>
                            </div>
                        </div>
                        <div>
                            <h6 class="font-semibold mb-2">Brand Impersonation Detection</h6>
                            <div class="p-4 border rounded-md">
                                <span x-text="results.brandImpersonationDetection"></span>
                            </div>
                        </div>
                        <div>
                            <h6 class="font-semibold mb-2">Pattern Analysis</h6>
                            <div class="p-4 border rounded-md">
                                <span x-text="results.patternAnalysis"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw XML Output -->
                <div class="panel">
                    <h6 class="text-lg font-bold mb-2">Raw XML Output</h6>
                    <div class="overflow-x-auto">
                        <table class="table-striped w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2">Header</th>
                                    <th class="px-4 py-2">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(value, key) in results.raw_headers" :key="key">
                                    <tr class="border-t">
                                        <td class="px-4 py-2 font-medium" x-text="key"></td>
                                        <td class="px-4 py-2 whitespace-pre-wrap break-words" x-html="value"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("alpine:init", () => {
        Alpine.data("emailAnalysis", () => ({
            emailContent: "",
            emailFile: null,
            loading: false,
            results: null,

            clearForm() {
                this.emailContent = "";
                this.emailFile = null;
                this.results = null;
            },

            handleFileUpload(event) {
                this.emailFile = event.target.files[0];
                // Handle file upload logic here
            },

            async analyzeEmail() {
                this.loading = true;
                // Simulated API call - replace with actual API integration
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Sample data - replace with actual API response
                this.results = {
                    from: "sender@example.com",
                    returnPath: "bounce@example.com",
                    spf: "Pass",
                    dkim: "Pass",
                    dmarc: "Pass",
                    alignment: "Aligned",
                    spoofingDetection: "No spoofing detected",
                    hopAnalysis: [
                        { id: 1, timestamp: "2023-10-01T12:00:00Z", description: "Received from mail server" },
                        { id: 2, timestamp: "2023-10-01T12:05:00Z", description: "Forwarded to recipient" }
                    ],
                    ipAnalysis: {
                        geoIpLocation: "New York, USA",
                        reverseDns: "mail.example.com",
                        reputation: "Good",
                        asnInformation: "AS12345",
                        historicalData: "No historical issues",
                        isMalicious: true,
                        maliciousPlatforms: ["VirusTotal", "AbuseIPDB"]
                    },
                    whoisDomainLookup: "Domain registered in 2020",
                    blocklistVerification: "Not listed",
                    urls: [
                        {
                            url: "http://example.com/path",
                            status: "Clean",
                            reputation: "Good",
                            domainAge: "2 years",
                            sslValidation: "Valid",
                            landingPageAnalysis: "Safe",
                            redirectionDetection: "None"
                        },
                        {
                            url: "http://suspicious.com/login",
                            status: "Suspicious",
                            reputation: "Poor",
                            domainAge: "1 month",
                            sslValidation: "Invalid",
                            landingPageAnalysis: "Phishing detected",
                            redirectionDetection: "Multiple redirects"
                        }
                    ],
                    attachments: [
                        {
                            name: "document.pdf",
                            status: "Clean",
                            hashMd5: "d41d8cd98f00b204e9800998ecf8427e",
                            hashSha1: "da39a3ee5e6b4b0d3255bfef95601890afd80709",
                            hashSha256: "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
                            fileType: "PDF",
                            staticAnalysis: "No threats detected",
                            sandboxAnalysis: "Safe"
                        },
                        {
                            name: "invoice.exe",
                            status: "Malicious",
                            hashMd5: "fcea920f7412b5da7be0cf42b8c93759",
                            hashSha1: "d34db33f0056c22545e30e46bfe51e8bbac29a65",
                            hashSha256: "9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08",
                            fileType: "Executable",
                            staticAnalysis: "Malware detected",
                            sandboxAnalysis: "Unsafe"
                        }
                    ],
                    displayNameSpoofing: "No display name spoofing detected",
                    lookAlikeDomainDetection: "No look-alike domains detected",
                    phishingKeywordAnalysis: "No phishing keywords detected",
                    urgencyIndicatorChecks: "No urgency indicators detected",
                    brandImpersonationDetection: "No brand impersonation detected",
                    patternAnalysis: "No suspicious patterns detected",
                    threatScore: "Low",
                    confidence: "High",
                    riskIndicators: {
                        low: "Low Risk",
                        medium: "Medium Risk",
                        high: "High Risk"
                    },
                    raw_headers: {
                        "Key1": "Value1",
                        "Key2": "Value2",
                        "Key3": "Value3"
                    }
                };

                this.loading = false;
            }
        }));
    });
</script>
{% endblock %}
