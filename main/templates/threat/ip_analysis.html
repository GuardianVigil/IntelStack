{% extends 'components/layouts/default.html' %}
{% load static %}

{% block content %}
<div x-data="ipAnalysis">
    <ul class="flex space-x-2 rtl:space-x-reverse">
        <li>
            <a href="{% url 'index' %}" class="text-primary hover:underline">Dashboard</a>
        </li>
        <li class="before:content-['/'] ltr:before:mr-1 rtl:before:ml-1">
            <span>IP Analysis</span>
        </li>
    </ul>

    <div class="pt-5">
        <div class="panel">
            <div class="flex items-center justify-between mb-5">
                <h5 class="font-semibold text-lg dark:text-white-light">IP Analysis</h5>
            </div>
            
            <div class="mb-5">
                <form @submit.prevent="analyzeIP" class="space-y-5">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="ipAddress">IP Address</label>
                            <input id="ipAddress" type="text" placeholder="Enter IP address" class="form-input" x-model="ipAddress" />
                        </div>
                        <div class="sm:pt-7">
                            <button type="submit" class="btn btn-primary">Analyze</button>
                        </div>
                    </div>
                </form>
            </div>

            <div x-show="loading" class="flex justify-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
            </div>

            <div x-show="!loading && results" class="space-y-5">
                <!-- IP Information -->
                <div>
                    <h6 class="text-lg font-bold mb-2">IP Information</h6>
                    <div class="table-responsive">
                        <table class="table-striped">
                            <tbody>
                                <tr>
                                    <td class="font-semibold">IP Address:</td>
                                    <td x-text="results.ip"></td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">Location:</td>
                                    <td x-text="results.location"></td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">ASN:</td>
                                    <td x-text="results.asn"></td>
                                </tr>
                                <tr>
                                    <td class="font-semibold">Risk Score:</td>
                                    <td>
                                        <div class="flex items-center">
                                            <div x-text="results.riskScore" class="mr-2"></div>
                                            <div class="h-2 w-20 bg-gray-200 rounded-full">
                                                <div class="h-full rounded-full" :class="{
                                                    'bg-success': results.riskScore < 30,
                                                    'bg-warning': results.riskScore >= 30 && results.riskScore < 70,
                                                    'bg-danger': results.riskScore >= 70
                                                }" :style="'width: ' + results.riskScore + '%'"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div>
                    <h6 class="text-lg font-bold mb-2">Recent Activities</h6>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Activity</th>
                                    <th>Category</th>
                                    <th>Severity</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="activity in results.activities" :key="activity.id">
                                    <tr>
                                        <td x-text="activity.date"></td>
                                        <td x-text="activity.description"></td>
                                        <td x-text="activity.category"></td>
                                        <td>
                                            <span class="badge" :class="{
                                                'badge-outline-success': activity.severity === 'Low',
                                                'badge-outline-warning': activity.severity === 'Medium',
                                                'badge-outline-danger': activity.severity === 'High'
                                            }" x-text="activity.severity"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("alpine:init", () => {
        Alpine.data("ipAnalysis", () => ({
            ipAddress: "",
            loading: false,
            results: null,

            async analyzeIP() {
                this.loading = true;
                // Simulated API call - replace with actual API integration
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Sample data - replace with actual API response
                this.results = {
                    ip: this.ipAddress,
                    location: "United States",
                    asn: "AS15169 Google LLC",
                    riskScore: 25,
                    activities: [
                        {
                            id: 1,
                            date: "2025-02-02",
                            description: "Port Scan Attempt",
                            category: "Reconnaissance",
                            severity: "Low"
                        },
                        {
                            id: 2,
                            date: "2025-02-01",
                            description: "Failed Login Attempts",
                            category: "Brute Force",
                            severity: "Medium"
                        }
                    ]
                };
                this.loading = false;
            }
        }));
    });
</script>
{% endblock %}
